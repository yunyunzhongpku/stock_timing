# Copilot·AIDE — 单文件版 AI 协作与编码规范

> 面向“机器阅读”的规则，要求 **一次性交付可运行、可测试、可维护** 的产物；对人类同样友好。  
> 优先级：**技术规范 > 协作流程**（编码时以本文件为准）。
>
> 本文为单文件合并版，整合自 `AIDE.md`、`AI协作指南.md`、`README_AI.md`。建议文件名：**.github/COPILOT_AIDE.md**。

---

## 0) 角色与定位
- **本文件** = 规则总纲：统一输出格式、技术口径、协作流程与检查清单（供 Copilot / Cursor / GPT / Claude 等读取执行）。
- 目标：**更少回合、一次成型**；信息不全时先给出**合理假设**并继续完成实现。

---

## 1) 交付契约（必须满足）
- **交付顺序**：代码 ▶ 最小单测 ▶ 使用片段 ▶ README 片段（参数表+简例）。
- **信息不全也要动手**：做**最合理假设**，并在提交末尾列出《假设清单》；仅在**高风险/大改动**时先提方案。
- **输出克制**：只给能跑的内容与必要说明；不写与任务无关的长文。
- **安全边界**：不得写入凭据/密钥；如需配置，提供 `.env.example`。
- **再现性**：固定随机种子，注明关键依赖版本。

---

## 2) 技术栈默认值（Python）
- 版本：**3.11+**（3.12 亦可）；推荐 conda 管理环境。
- 依赖白名单：`pandas, numpy, scipy, statsmodels, scikit-learn, matplotlib`。
- 质量工具：`pytest`（最小单测必备），建议 `ruff / mypy / pre-commit`，统一入口可用 `pyproject.toml`。
- 注意：路径或平台差异不应写死在库代码里（示例路径放到脚本/README）。

---

## 3) 量化约定（命名与口径）
- 常用命名：`returns, price, nav, volatility, drawdown, sharpe_ratio, max_dd, rolling_corr, risk_parity_weights`。
- 年化口径：日频×√252；周频×√52；月频×√12；**按输入频率选择并在注释注明**。
- 文档注释：用中文 Docstring 解释统计假设/窗口/频率/年化/适用与局限。

---

## 4) 架构：I/O 与计算分离（强制）
**目标**：把“拿数据”（不稳定）与“算指标”（应可离线且纯函数）彻底分开，获得**可测试 / 可替换 / 可复现 / 可审计**。


**职责边界**
- `io/*`：网络/鉴权/最小清洗/频率对齐/缺口处理/缓存；**不做**统计计算。
- `metrics/*`：**纯函数**，仅收 `Series/DataFrame` 返回结果；**不访问网络**；可提供极简 `quick_plot_*`。

---

## 5) 稳健性与边界处理
- 对 **NaN/Inf/零除/空列/短窗口/异常值/奇异矩阵** 提供显式防护或降级（如对角加载、特征值夹紧）。
- 所有失败路径可追踪：日志/警告需包含“何处/原因/如何降级”。

---

## 6) 测试与验证
- **最小单测**：每个核心函数至少 1 个边界用例（空列/全零/NaN/短窗口/奇异矩阵）。
- **可视化自检**：关键指标至少 1 张最小图（保存 PNG）用于肉眼排查。
- **离线复跑**：IO 结果可落地缓存；说明如何在无网络下复现。

---

## 7) 协作流程与冲突消解
- **小改/低风险任务**：直接实现 → 在末尾列出《假设清单》与《边界处理摘要》。
- **大改/高风险任务（重构/新模块/架构调整）**：先给**规划提案**（目录/接口/数据流/边界与风险清单 + 5–7 条质量 Rubric 自评），**同一提交**附实现与单测。
- **参数化与模块化**：关键阈值/窗口做成参数；函数拆分清晰，便于复用与测试。
- **增量可合并**：尽量保持每次提交可运行、可合并。

> 当“先确认再执行”与“一次成型”冲突时，以**一次成型**为准（先交可运行版本 + 假设清单）；仅在**高风险场景**走“先方案后实现”的两段式。

---

## 8) 统一输出格式（所有任务用同一结构）
1. **修改/新增文件清单**（精确到函数/入口）  
2. **代码块**（可直接运行）  
3. **`pytest` 单测代码**（至少 1 个边界用例）  
4. **使用片段**（一段可复制运行的命令/脚本）  
5. **README 片段**（参数表 + 最小示例）  
6. **假设清单** 与 **已处理的边界/降级说明**

---

## 9) 任务模板（直接填充）
```xml
<task>
  <goal>用一句话描述任务目标</goal>
  <changes>
    - 新建/修改的文件与函数清单（精准到函数名）
  </changes>
  <constraints>
    - 输入/输出数据结构（index/columns/频率/缺口策略）
    - 计算层不得访问网络；I/O 与计算分离
  </constraints>
  <deliverables>
    - 代码、单测（含边界）、使用片段、README 片段
  </deliverables>
  <quality>
    - 覆盖边界：空/NaN/全零/短窗口/奇异矩阵
    - 年化与命名遵循 Copilot·AIDE 的量化约定
  </quality>
  <reflection optional="true">
    - 若属重构/架构任务：先给规划/数据流/风险清单与自评 Rubric
  </reflection>
</task>
```

---

## 10) Markdown 规范（写文档必做）
- **空行规则**：标题/代码块/列表/表格/引用块**前后必须有空行**。
- **代码块**：必须指定语言标识（`bash`/`python`/`text`/`json`/`sql`/`xml`）；前后空行。
- **标题唯一**：避免重复标题文本；必要时改变层级或标题文案。
- **提交前检查**：运行 `markdownlint`（或等效 linter），在 VS Code/GitHub 预览确认渲染无误。

---

## 11) 文档驱动与项目治理
- **先扫描后开发**：重大变更前扫描项目结构，明确依赖与数据流。
- **文档先行 & 实时同步**：设计前写要点，合并时更新实施文档与 README/CHANGELOG。
- **结构可视化**：关键模块/数据流用简图或要点列出，降低认知负担。
- **版本与索引**：在 README/索引中标注文档职责差异与更新日期（本文件即“索引+规范”的合体）。

---

## 12) AI/ML 项目补充
- 兼容常见框架（Hugging Face / LangChain / OpenAI API）；**关注点分离**与数据处理流水线清晰。
- 输出以**清晰、模块化、可复用**为首要目标；必要处给最小推理/训练脚本。

---

## 13) 快速收尾清单（1 分钟核对）
- [ ] 代码能跑；`pytest -q` 通过  
- [ ] README/CHANGELOG 更新 1–2 行（若涉及接口/口径变化）  
- [ ] 计算层未访问网络；I/O 分层清晰  
- [ ] 至少 1 个边界用例；最小图能生成或保存为 PNG  
- [ ] 提交末尾包含《假设清单》与《边界/降级说明》

---

### 附：维护建议
- 根据项目演进，动态调整**依赖白名单**、**默认年化口径**、**I/O 策略**（缓存/退避重试/失败回退到本地文件）。
- 提升测试门槛（覆盖率阈值、必测清单模板）；引入一键脚本（例如 `make test` / `make report`）。
