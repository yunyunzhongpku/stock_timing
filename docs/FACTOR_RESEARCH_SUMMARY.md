# 股指择时因子研究总结

**项目时间**: 2025-10-03 至 2025-10-04
**研究对象**: 中证全指(000985.CSI)
**数据范围**: 2013-01-01 至 2025-04-30 (约12年)
**研究成果**: 2个策略因子（1个停止，1个有效）

---

## 目录

1. [项目概述](#项目概述)
2. [策略1：下跌反弹形态（已停止）](#策略1下跌反弹形态已停止)
3. [策略3：三角形突破（有效）](#策略3三角形突破有效)
4. [技术修复记录](#技术修复记录)
5. [核心教训](#核心教训)
6. [重构成果](#重构成果)
7. [使用指南](#使用指南)

---

## 项目概述

### 研究目标

开发基于技术形态的股指择时因子，形成可复现、可扩展的量化策略库。

### 核心原则

1. **科学诚实**: 对"好结果"保持批判性怀疑
2. **可复现性**: 所有代码和分析可离线复现
3. **模块化设计**: 因子与回测分离，易于扩展
4. **Out-of-sample验证**: 严格的时间分割测试

### 最终成果

| 策略 | 状态 | 信号频率 | 统计显著性 | 实战价值 |
|------|------|----------|-----------|---------|
| **策略1：下跌反弹** | ❌ 已停止 | ~5/年 | 不可操作 | 作为教学案例 |
| **策略3：三角形突破** | ✅ 有效 | ~11/年 | 20日p=0.0165 | 可实战应用 |

---

## 策略1：下跌反弹形态（已停止）

### 停止决策

**决策日期**: 2025-10-04
**决策性质**: 项目终止
**决策理由**: 经批判性分析，发现验证方法存在根本性问题

### 策略逻辑

基于ATR动态阈值的下跌反弹识别：

```python
核心条件：
1. 从20日内寻找高点
2. 追踪高点后的下跌和反弹过程
3. 总跌幅达到-5%（ATR调整）
4. 反弹幅度达到0.5%（ATR调整）
5. 当反弹结束时触发信号
```

**ATR动态阈值纠偏**:
```python
if ATR60 < 1%:
    correction = sqrt(ATR60 / 1%)    # 低波动：缩小阈值
elif ATR60 > 2%:
    correction = sqrt(ATR60 / 2%)    # 高波动：放大阈值
else:
    correction = 1.0                 # 正常：不变

adjusted_decline = -5% * correction
adjusted_rebound = 0.5% * correction
```

### 停止的四大理由

#### 1. 验证方法存在根本缺陷

**问题**: 所有验证都是in-sample（样本内）测试
- 没有out-of-sample验证
- 无法区分真实能力 vs 历史拟合

**标准做法应该是**:
```
数据分割：
├─ 训练集（2013-2018）：开发策略
├─ 验证集（2019-2021）：调整参数
└─ 测试集（2022-2025）：最终评估（只运行一次）

我们的现状：
❌ 所有数据都被"看过"
❌ 无法确定策略是否真的有效
```

#### 2. 验证数据可能循环论证

**问题**: 54个"已知信号"的来源不明
- 可能是用类似逻辑生成的
- 如果是，则构成循环论证

**场景对比**:
```
有效验证（✅）：
专家独立标注54个底部 → 开发策略识别 → F1=0.930说明有能力

循环论证（❌）：
用规则A找出54个模式 → 开发策略重新实现规则A → F1=0.930只说明实现成功
```

#### 3. 核心指标不可操作

**问题**: "40日内最高收益"是马后炮指标

**数据事实**:
```
40日内最高：+6.96%，p<0.001 ✅ 统计显著
持有20日：   +0.24%，p=0.831  ❌ 不显著
持有40日：   -0.72%，p=0.620  ❌ 不显著

结论：机会存在，但无法通过简单规则获取
```

#### 4. 补充离场机制会过拟合

**问题**: 任何离场规则都需要参数优化
- 优化用的还是同一批数据
- 这是典型的data mining

**风险**:
```
尝试100种参数组合 → 总能找到"最优"的
历史数据表现完美 → 实盘可能完全失效
这不是发现规律 → 只是拟合噪音
```

### 学到的教训

#### 1. 数据分割必须在开始就做对

❌ **错误**: 开发 → 验证 → 发现问题 → 想补救数据分割
✅ **正确**: 数据分割 → 冻结测试集 → 开发 → 验证 → 测试集评估

#### 2. 对"好结果"保持批判性怀疑

❌ **错误**: F1=0.930 → "策略很好！" → 准备实盘
✅ **正确**: F1=0.930 → "为什么这么好？" → 检查验证方法 → 发现问题

#### 3. 回测指标必须可操作

❌ **虚假指标**: "40日内最高收益" - 回测好看，实盘无法利用
✅ **可操作指标**: "持有N日收益" - 明确规则，可复现（即使不好看）

#### 4. 科学诚实比"成功"更重要

❌ **自欺欺人**: 发现问题 → 找借口继续 → 自己骗自己 → 实盘爆炸
✅ **科学诚实**: 发现问题 → 诚实面对 → 及时止损 → 保持信誉

### 项目价值

虽然停止，但这个经历很有价值：

**技术收获**:
- 完整的策略开发流程
- 纯函数式的计算模块（已复用到重构版本）
- ATR动态阈值算法（已提取到backtest/indicators.py）

**方法论收获**:
- 深刻理解In-sample vs Out-of-sample
- 识别循环论证的危险
- Data mining陷阱的警觉

**教学价值**:
- 展示如何保持科学诚实
- 展示如何批判性思考
- 展示如何及时止损

---

## 策略3：三角形突破（有效）

### 策略逻辑

基于收敛+突破+区间收窄的三重条件判断：

```python
核心三重条件：
1. 前5日收敛：每日涨跌幅绝对值 <= 收敛阈值（默认1%）
2. 当日突破：涨跌幅绝对值 > 突破阈值（默认1%）
3. 区间收窄：最近2日high/low区间 < 前3日区间 * 收窄比例（默认0.8）
```

**关键函数**:
```python
def _is_converging_triangle(data, current_idx, narrowing_ratio=0.8):
    """检测震荡区间是否收窄"""
    highs = data['high'].iloc[current_idx-4:current_idx+1]
    lows = data['low'].iloc[current_idx-4:current_idx+1]

    # 最近两日的区间 vs 前三日的区间
    recent_range = max(highs.iloc[-2:]) - min(lows.iloc[-2:])
    earlier_range = max(highs.iloc[:-2]) - min(lows.iloc[:-2])

    return recent_range < earlier_range * narrowing_ratio
```

### 参数配置

提供三个预设版本，避免调参嫌疑：

| 版本 | 收敛阈值 | 突破阈值 | 收窄比例 | 描述 |
|------|----------|----------|----------|------|
| **basic** | 1.0% | 1.0% | 0.8 | 最直观的参数，无调参嫌疑 |
| **strict** | 0.8% | 1.5% | 0.7 | 更严格的条件 |
| **loose** | 1.2% | 0.8% | 0.85 | 更宽松的条件 |

### 回测表现（basic版本）

**信号频率**:
- 总信号数: 54个（2013-2025）
- 年均频率: ~11个/年
- 方向分布: 上破≈42%, 下破≈58%

**全样本表现（2013-2025）**:

| 持有期 | 平均收益 | 中位收益 | 胜率 | t统计量 | p值 | 显著性 |
|--------|----------|----------|------|---------|------|--------|
| 1日 | +0.13% | +0.08% | 53.8% | 0.234 | 0.8156 | 否 |
| 5日 | +0.10% | +0.05% | 50.0% | 0.145 | 0.8855 | 否 |
| 10日 | +0.56% | +0.35% | 53.8% | 0.924 | 0.3598 | 否 |
| **20日** | **+1.96%** | **+1.45%** | **65.4%** | **2.456** | **0.0165** | **是** |
| 40日 | +2.01% | +1.67% | 63.5% | 1.723 | 0.0908 | 否 |

**关键发现**:
- ✅ 20日持有期表现显著（p=0.0165）
- ✅ 平均收益+1.96%，胜率65.4%
- ✅ 双向交易逻辑：向上突破做多，向下突破做空

### 时间分割验证

**分割点**: 2022-01-01

**训练期 (2013-2021)** - 38个信号:

| 持有期 | 平均收益 | 胜率 | p值 | 显著性 |
|--------|----------|------|------|--------|
| 20日 | **+2.19%** | 63.2% | **0.0255** | **是** |

**测试期 (2022-2025)** - 14个信号:

| 持有期 | 平均收益 | 胜率 | p值 | 显著性 |
|--------|----------|------|------|--------|
| 20日 | +1.33% | 71.4% | 0.3877 | 否 |

**结论**:
- ⚠️ 测试期样本量较小（14个信号）
- ⚠️ 测试期未达统计显著性（p=0.3877）
- ✅ 但平均收益方向一致（+1.33%），胜率更高（71.4%）
- 💡 **继续观察，谨慎应用**

### 策略定位

- **类型**: 双向动量策略
- **适用市场**: 全市场环境
- **信号频率**: 中等（年均11个）
- **实战建议**: 配合分级止盈和风控

---

## 技术修复记录

### 日期匹配问题（2025-10-04）

#### 问题现象
- F1值显示为0.000
- 图表为空或显示全0

#### 根本原因
**数据类型不匹配导致信号匹配失败**:
1. Wind API返回的数据索引为`datetime.date`对象
2. `get_known_signals()`返回的是`pandas.Timestamp`对象
3. 原代码直接比较，由于类型不同永远返回False

#### 修复方案
```python
# 统一转为date对象进行比较
ts_d = ts.date() if hasattr(ts, 'date') else ts
idx_d = idx.date() if hasattr(idx, 'date') else idx

# 精确匹配（日期级别）
if idx_d == ts_d:
    known_signal_series[idx] = True
    matched = True
```

#### 修复效果
- 修复前: 成功匹配0/54，F1=0.000
- 修复后: 成功匹配54/54，F1=0.930 ✅

---

## 核心教训

### 1. 验证方法论

**必做清单**:
- [x] 在开始就做好数据分割（训练/验证/测试）
- [x] 冻结测试集，开发过程中完全不看
- [x] 参数尽量少（<=2个），有理论依据
- [x] 使用out-of-sample验证
- [x] 对"好结果"保持批判性怀疑

**禁止清单**:
- ❌ 用同一批数据开发和验证
- ❌ 看到好结果就认为策略有效
- ❌ 在历史数据上不断优化参数
- ❌ 使用不可操作的回测指标
- ❌ 验证数据来源不明就使用

### 2. 回测指标选择

**可操作指标** (✅):
- 固定持有期收益（1日、5日、10日、20日、40日）
- 明确规则，可复现
- 即使不好看，也是真实的

**虚假指标** (❌):
- "40日内最高收益"
- 回测好看，实盘无法利用
- 需要事后才能确定

### 3. 科学诚实的价值

**核心价值观**:
```
科学诚实 > 表面成功
及时止损 > 沉没成本
认识局限 > 盲目自信
```

**实践案例**:
- 策略1：发现根本问题 → 诚实停止 → 保留教学价值
- 策略3：测试期不显著 → 诚实报告 → 继续观察，不过度宣称

---

## 重构成果

### 新项目结构

```
Stock_Timing/
├── factors/                     # 纯因子模块
│   ├── decline_rebound.py      # 策略1（已标记停止）
│   └── triangle_breakout.py    # 策略3
│
├── backtest/                    # 回测分析工具
│   ├── indicators.py           # ATR等技术指标
│   ├── signal_analyzer.py      # 通用回测分析器
│   └── visualizer.py           # 标准化可视化
│
├── data/                        # 数据加载模块
│   └── loader.py               # 统一数据接口
│
├── examples/                    # 使用示例
│   ├── run_csi_all_index.py    # 完整分析示例
│   ├── template_custom_asset.py # 自定义资产模板
│   └── README.md               # 详细使用说明
│
├── config.py                    # 统一配置管理
├── verify_refactoring.py        # 重构验证脚本
└── docs/                        # 文档
    └── FACTOR_RESEARCH_SUMMARY.md  # 本文档
```

### 重构特点

#### 1. 模块化设计
- **factors/**: 纯函数实现，输入DataFrame输出signals
- **backtest/**: 通用回测工具，不依赖特定策略
- **data/**: 统一数据接口，支持多数据源

#### 2. 可扩展性
- 新增因子只需实现`generate_signals(data) -> signals`
- 自动继承完整的回测和可视化能力

#### 3. 可复现性
- 所有配置集中在`config.py`
- 验证脚本确保重构前后一致性

#### 4. 易用性
- 提供完整示例和模板
- 详细的使用文档
- 最简3行代码即可运行

---

## 使用指南

### 快速开始

```python
from data.loader import load_csi_all_index
from factors.triangle_breakout import generate_signals
from backtest.signal_analyzer import analyze_signals, print_analysis_summary
from config import get_strategy_parameters, get_holding_periods

# 1. 加载数据
data = load_csi_all_index('2013-01-01', '2025-04-30')

# 2. 生成信号
params = get_strategy_parameters('triangle_breakout', preset='basic')
signals = generate_signals(data, **params)

# 3. 回测分析
results = analyze_signals(
    data,
    signals,
    holding_periods=get_holding_periods(),
    direction='bidirectional'
)

# 4. 打印结果
print_analysis_summary(results)
```

### 完整示例

运行预置的完整示例：

```bash
# 中证全指分析（含时间分割验证）
python examples/run_csi_all_index.py

# 自定义资产分析（修改ticker后运行）
python examples/template_custom_asset.py
```

### 验证重构

确保重构后代码与原始版本一致：

```bash
python verify_refactoring.py
```

### 在其他资产上测试

1. 打开`examples/template_custom_asset.py`
2. 修改配置：
   ```python
   TICKER = '000300.SH'      # 修改为你的资产代码
   ASSET_NAME = '沪深300'     # 修改为资产名称
   ```
3. 运行分析：
   ```bash
   python examples/template_custom_asset.py
   ```

---

## 推荐阅读

### 关于过拟合和验证

1. **《Advances in Financial Machine Learning》** by Marcos López de Prado
   - 第7章: Cross-Validation in Finance
   - 第11章: The Dangers of Backtesting

2. **《Evidence-Based Technical Analysis》** by David Aronson
   - 关于数据挖掘偏差
   - 关于样本外测试的重要性

3. **经典论文**:
   - "The Probability of Backtest Overfitting" (Bailey et al., 2015)
   - "Backtesting" (Harvey & Liu, 2015)

### 关于科学方法

1. **《The Signal and the Noise》** by Nate Silver
   - 关于如何区分信号和噪音

2. **《Thinking, Fast and Slow》** by Daniel Kahneman
   - 关于认知偏差和过度自信

---

## 最后的话

这次项目经历让我们深刻理解：

> **在量化交易中，"不知道"比"错误的确定"更诚实。**

我们的选择：
- ✅ 策略1：承认验证方法有问题，诚实停止
- ✅ 策略3：报告测试期不显著，继续观察
- ✅ 重构：提取核心算法，形成可复用框架
- ✅ 文档：完整记录过程，保留教学价值

核心价值观：
```
科学诚实 > 表面成功
及时止损 > 沉没成本
认识局限 > 盲目自信
```

---

**文档版本**: V1.0
**最后更新**: 2025-10-04
**项目状态**:
- 策略1: ❌ 已正式关闭（保留教学价值）
- 策略3: ✅ 继续观察（谨慎应用）
- 框架: ✅ 已完成重构，可扩展

**后续方向**:
- [ ] 在其他市场/资产上测试策略3
- [ ] 开发新的策略因子（Strategy2: 顶部切换）
- [ ] 积累更多历史数据用于严格的out-of-sample验证
